<script>
  // Initialize Notyf for notifications
const notyf = new Notyf({
    duration: 3000,
    position: { x: 'center', y: 'top' },
    types: [{
        type: 'success',
        background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        icon: { className: 'bi bi-check-circle', tagName: 'i' }
    }]
});

// Load saved preferences
let currentLanguage = localStorage.getItem('preferred-language') || 'english';
let currentTheme = localStorage.getItem('preferred-theme') || 'light';
let favoriteIds = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));

// Global data store
let allPhrasesData = [];
let isDataLoaded = false;

// --- Favorites Management Functions ---
function renderFavorites(lang = currentLanguage) {
    const container = document.getElementById("favorites-list");
    if (!container) return;
    
    container.innerHTML = "";

    if (favoriteIds.size === 0) {
        container.innerHTML = `<div class="alert alert-info mt-3">No favorites added yet ⭐</div>`;
        return;
    }

    if (!isDataLoaded || !allPhrasesData || allPhrasesData.length === 0) {
        container.innerHTML = `<div class="alert alert-warning mt-3">Loading favorites...</div>`;
        return;
    }

    // Filter phrases that are favorited
    const favorites = allPhrasesData.filter(item => favoriteIds.has(item.id));

    if (favorites.length === 0) {
        container.innerHTML = `<div class="alert alert-warning mt-3">Favorite items not found in current data</div>`;
        return;
    }

    favorites.forEach(item => {
        let translation = item[lang] || item.english || "";
        let pronunciation = item[`${lang}_p`] || "";
        
        container.innerHTML += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                    <div class="fw-bold fs-5 text-primary mb-1">${item.arabic}</div>
                    ${pronunciation ? `<div class="text-muted small mb-1">${pronunciation}</div>` : ''}
                    <div class="text-dark">${translation}</div>
                    ${item.tags && item.tags.length > 0 ? 
                        `<div class="mt-2">
                            ${item.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                        </div>` : ''}
                </div>
                <div class="ms-3">
                    <button class="btn btn-sm btn-outline-danger remove-fav" data-id="${item.id}" title="Remove from favorites">
                        <i class="bi bi-heart-fill"></i>
                    </button>
                </div>
            </div>
        `;
    });

    // Handle remove from favorites
    document.querySelectorAll(".remove-fav").forEach(btn => {
        btn.addEventListener("click", function () {
            const id = parseInt(this.dataset.id);
            favoriteIds.delete(id);
            localStorage.setItem("favorites", JSON.stringify(Array.from(favoriteIds)));
            renderFavorites(lang);
            notyf.success('Removed from favorites');
        });
    });
}

function toggleFavorite(id) {
    if (favoriteIds.has(id)) {
        favoriteIds.delete(id);
        notyf.success('Removed from favorites');
    } else {
        favoriteIds.add(id);
        notyf.success('Added to favorites');
    }
    localStorage.setItem('favorites', JSON.stringify(Array.from(favoriteIds)));
    
    // Re-render favorites if we're on the favorites page
    const favoritesContainer = document.getElementById("favorites-list");
    if (favoritesContainer) {
        renderFavorites(currentLanguage);
    }
}
// --- Theme Toggle Functionality ---
const themeToggle = document.getElementById('themeToggle');
const themeIcon = themeToggle ? themeToggle.querySelector('i') : null;

function updateThemeIcon(theme) {
    if (!themeIcon) return;
    if (theme === 'dark') {
        themeIcon.className = 'bi bi-sun fs-5';
    } else {
        themeIcon.className = 'bi bi-moon fs-5';
    }
}

// Initialize theme
document.documentElement.setAttribute('data-bs-theme', currentTheme);
updateThemeIcon(currentTheme);

if (themeToggle) {
    themeToggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-bs-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('preferred-theme', newTheme);
        currentTheme = newTheme;
        updateThemeIcon(newTheme);
        
        notyf.success(`Switched to ${newTheme} mode`);
    });
}

// --- Language Toggle Functionality ---
const langRadios = document.querySelectorAll('input[name="lang"]');
const langLabels = document.querySelectorAll('.lang-btn');
const searchBox = document.getElementById('searchBox');
const resultsContainer = document.getElementById('results');
const spinner = document.getElementById('spinner');

function updateCurrentLanguage() {
    const checkedRadio = document.querySelector('input[name="lang"]:checked');
    if (checkedRadio) {
        currentLanguage = checkedRadio.value;
        localStorage.setItem('preferred-language', currentLanguage);
    }
    
    // Re-render favorites with new language if favorites page is active
    if (document.getElementById("favorites-list")) {
        renderFavorites(currentLanguage);
    }
    
    const query = searchBox ? searchBox.value.trim() : '';
    if (query.length > 1 || (resultsContainer && resultsContainer.children.length > 0)) {
        performSearch(query);
    }
}

function initLanguageSelection() {
    const savedLangRadio = document.querySelector(`input[value="${currentLanguage}"]`);
    if (savedLangRadio) {
        savedLangRadio.checked = true;
        const savedLabel = document.querySelector(`label[for="${savedLangRadio.id}"]`);
        if (savedLabel) {
            savedLabel.classList.add('active');
        }
    }
}

if (langRadios.length > 0) {
    langRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            langLabels.forEach(label => label.classList.remove('active'));
            const newLabel = document.querySelector(`label[for="${radio.id}"]`);
            if (newLabel) {
                newLabel.classList.add('active');
            }
            updateCurrentLanguage();
            notyf.success(`Language switched to ${radio.value}`);
        });
    });
}
// --- IndexedDB & Data Loading ---
const DB_NAME = 'searchDatabase';
const DB_VERSION = 1;
const OBJECT_STORE_NAME = 'searchPhrases';
let db;

function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = event => reject(event.target.error);
        request.onupgradeneeded = event => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(OBJECT_STORE_NAME)) {
                const objectStore = db.createObjectStore(OBJECT_STORE_NAME, { keyPath: 'id' });
                objectStore.createIndex('arabic', 'arabic', { unique: false });
                objectStore.createIndex('english', 'english', { unique: false });
                objectStore.createIndex('tags', 'tags', { unique: false, multiEntry: true });
            }
        };
        request.onsuccess = event => {
            db = event.target.result;
            resolve(db);
        };
    });
}

async function fetchDataAndStoreInDB() {
    try {
        const response = await fetch('/data/main.json');
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        
        const transaction = db.transaction([OBJECT_STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(OBJECT_STORE_NAME);
        
        await new Promise((resolve, reject) => {
            const clearRequest = objectStore.clear();
            clearRequest.onsuccess = () => resolve();
            clearRequest.onerror = event => reject(event.target.error);
        });
        
        data.forEach(item => objectStore.add(item));
        
        transaction.oncomplete = () => {
            allPhrasesData = data;
            isDataLoaded = true;
            displayAvailableTags();
            initCategoryCards();
            // Render favorites if we're on the favorites page
            if (document.getElementById("favorites-list")) {
                renderFavorites(currentLanguage);
            }
            notyf.success('Search data updated successfully!');
            console.log('All data added to IndexedDB and memory');
        };

        transaction.onerror = event => {
            console.error('Transaction error:', event.target.error);
            notyf.error('Failed to save search data.');
        };
    } catch (error) {
        console.error('Error fetching or storing data:', error);
        notyf.error('Failed to load search data from the server.');
    }
}

async function loadDataAndInit() {
    try {
        await initDB();
        const transaction = db.transaction([OBJECT_STORE_NAME], 'readonly');
        const objectStore = transaction.objectStore(OBJECT_STORE_NAME);
        const countRequest = objectStore.count();

        countRequest.onsuccess = async event => {
            if (event.target.result === 0) {
                await fetchDataAndStoreInDB();
            } else {
                console.log('IndexedDB already contains data.');
                const getAllRequest = objectStore.getAll();
                getAllRequest.onsuccess = event => {
                    allPhrasesData = event.target.result;
                    isDataLoaded = true;
                    displayAvailableTags();
                    displayRecentSearches();
                    initCategoryCards();
                    // Render favorites if we're on the favorites page
                    if (document.getElementById("favorites-list")) {
                        renderFavorites(currentLanguage);
                    }
                };
                getAllRequest.onerror = event => {
                    console.error('Failed to get all data:', event.target.error);
                    notyf.error('Failed to load data from IndexedDB.');
                };
            }
        };
    } catch (error) {
        console.error('Failed to initialize or check DB:', error);
    }
}

// --- Category Cards Initialization ---
function browseByTag(tagValue, label = '') {
    if (!isDataLoaded || !allPhrasesData || allPhrasesData.length === 0) {
        notyf.error('Data not loaded yet. Please wait...');
        return;
    }

    if (searchBox) searchBox.value = '';

    filteredResults = allPhrasesData.filter(item => {
        return item.tags && Array.isArray(item.tags) && item.tags.includes(tagValue);
    });

    currentPage = 1;
    displaySearchResults(filteredResults.slice(0, RESULTS_PER_PAGE));

    if (label) {
        notyf.success(`Browsing "${label}"`);
    }

    smoothScrollToResults();
}

function initCategoryCards() {
    const categoryCards = document.querySelectorAll('.category-card');
    categoryCards.forEach(card => {
        card.addEventListener('click', () => {
            const tagValue = card.dataset.tag;
            browseByTag(tagValue, `${tagValue} category`);
        });
    });
}

function initCategoryShortcuts() {
    const shortcuts = document.querySelectorAll('.category-shortcuts .shortcut');
    shortcuts.forEach(button => {
        button.addEventListener('click', () => {
            const tagValue = button.dataset.tag;
            browseByTag(tagValue, `${tagValue} phrases`);
        });
    });
}

function initQuickNav() {
    document.querySelectorAll('.nav-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            const targetId = chip.dataset.scroll;
            if (targetId) {
                const targetEl = document.querySelector(targetId);
                if (targetEl) {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
    });
}

// --- Favorites Toggle Buttons ---
const favoritesToggleBtn = document.getElementById('favoritesToggle');
const showAllBtn = document.getElementById('showAll');

if (favoritesToggleBtn) {
    favoritesToggleBtn.addEventListener('click', () => {
        if (!isDataLoaded) {
            notyf.error('Data not loaded yet. Please wait...');
            return;
        }
        const favorites = allPhrasesData.filter(item => favoriteIds.has(item.id));
        displaySearchResults(favorites);
        favoritesToggleBtn.style.display = 'none';
        if (showAllBtn) showAllBtn.style.display = 'inline-block';
    });
}

if (showAllBtn) {
    showAllBtn.addEventListener('click', () => {
        if (!isDataLoaded) {
            notyf.error('Data not loaded yet. Please wait...');
            return;
        }
        displaySearchResults(allPhrasesData);
        showAllBtn.style.display = 'none';
        if (favoritesToggleBtn) favoritesToggleBtn.style.display = 'inline-block';
    });
}

// --- Search and Filtering Functions ---
let searchTimeout;
const RESULTS_PER_PAGE = 10;
let currentPage = 1;
let filteredResults = [];
const loadMoreBtn = document.getElementById('loadMoreBtn');

if (searchBox) {
    searchBox.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        clearTimeout(searchTimeout);

        if (query.length < 2) {
            filteredResults = allPhrasesData;
            currentPage = 1;
            displaySearchResults(filteredResults.slice(0, RESULTS_PER_PAGE));
            return;
        }

        if (spinner) spinner.style.display = 'block';
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 250);
    });
}

function filterData(query) {
    if (!query) return allPhrasesData;
    const lowerCaseQuery = query.toLowerCase();
    const queryWords = lowerCaseQuery.split(/\s+/).filter(word => word.length > 0);

    return allPhrasesData.filter(item => {
        const searchableParts = [
            item.arabic,
            item.english,
            item.english_p,
            item.bangla,
            item.bangla_p,
            item.hindi,
            item.hindi_p,
            item.urdu,
            item.urdu_p,
            item.tags ? item.tags.join(' ') : ''
        ].filter(Boolean);

        const searchableText = searchableParts.join(' ').toLowerCase();
        return queryWords.every(word => searchableText.includes(word));
    });
}

function fuzzyFilterData(query) {
    if (!query) return [];

    const fuzzyPattern = query.split(/\s+/).filter(word => word.length > 0)
        .map(word => [...word].join('.*'))
        .join('.*');

    const fuzzyRegex = new RegExp(fuzzyPattern, 'i');

    return allPhrasesData.filter(item => {
        const searchableParts = [
            item.arabic,
            item.english,
            item.english_p,
            item.bangla,
            item.bangla_p,
            item.hindi,
            item.hindi_p,
            item.urdu,
            item.urdu_p,
            item.tags ? item.tags.join(' ') : ''
        ].filter(Boolean);

        const searchableText = searchableParts.join(' ').toLowerCase();
        return fuzzyRegex.test(searchableText);
    });
}

function performSearch(query) {
    if (!isDataLoaded) {
        notyf.error('Data not loaded yet. Please wait...');
        if (spinner) spinner.style.display = 'none';
        return;
    }
    
    let results = [];
    const exactMatches = filterData(query);
    
    if (exactMatches.length === 0) {
        results = fuzzyFilterData(query);
    } else {
        results = exactMatches;
    }

    filteredResults = results;
    currentPage = 1;
    
    setTimeout(() => {
        if (spinner) spinner.style.display = 'none';
        displaySearchResults(filteredResults.slice(0, RESULTS_PER_PAGE));
        addToRecentSearches(query);
        setTimeout(smoothScrollToResults, 150); 
    }, 300); 
}

function displaySearchResults(results) {
    if (!resultsContainer) return;
    
    if (currentPage === 1) {
        resultsContainer.innerHTML = '';
    }

    if (results.length === 0 && currentPage === 1) {
        resultsContainer.innerHTML = `<div class="col-12"><p class="text-center text-muted mt-5">No results found.</p></div>`;
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        return;
    }

    results.forEach(result => {
        const cardHtml = createResultCard(result, currentLanguage);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cardHtml.trim();
        const cardElement = tempDiv.firstChild;
        
        resultsContainer.appendChild(cardElement);
        
        const favoriteBtn = cardElement.querySelector('.favorite-btn');
        const copyBtn = cardElement.querySelector('.copy-btn');

        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', () => {
                toggleFavorite(result.id);
                const icon = favoriteBtn.querySelector('i');
                icon.className = favoriteIds.has(result.id) ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';
            });
        }

        if (copyBtn) {
            copyBtn.addEventListener('click', async () => {
                const text = copyBtn.dataset.text;
                try {
                    await navigator.clipboard.writeText(text);
                    notyf.success('Copied to clipboard');
                } catch (err) {
                    notyf.error('Failed to copy');
                }
            });
        }
    });

    const totalDisplayed = currentPage * RESULTS_PER_PAGE;
    if (totalDisplayed < filteredResults.length) {
        if (loadMoreBtn) loadMoreBtn.style.display = 'block';
    } else {
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
    }
}

function createResultCard(result, lang) {
    const translationKey = lang;
    const pronunciationKey = `${lang}_p`;
    const heartClass = favoriteIds.has(result.id) ? 'bi-heart-fill text-danger' : 'bi-heart';

    let badgeText = '';
    let badgeClass = '';
    switch (lang) {
        case 'english': badgeText = 'EN'; badgeClass = 'bg-primary'; break;
        case 'bangla': badgeText = 'বাং'; badgeClass = 'bg-success'; break;
        case 'hindi': badgeText = 'हिं'; badgeClass = 'bg-warning'; break;
        case 'urdu': badgeText = 'اردو'; badgeClass = 'bg-info'; break;
        default: badgeText = 'EN'; badgeClass = 'bg-primary';
    }

    const tagsHtml = (result.tags || [])
        .map(tag => `<span class="badge bg-secondary me-1 tag-clickable" data-tag="${tag}">${tag}</span>`)
        .join('');

    return `
        <div class="col-12 col-md-6 col-lg-4">
            <div class="glass-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="arabic-text fs-2 fw-bold text-primary">${result.arabic}</div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary favorite-btn" data-id="${result.id}">
                            <i class="bi ${heartClass}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary copy-btn" data-text="${result.arabic}">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="text-muted small mb-1">Pronunciation</div>
                    <div class="fw-medium">${result[pronunciationKey] || ''}</div>
                </div>

                <div class="translations mb-3">
                    <div class="mb-2">
                        <span class="badge ${badgeClass} me-2">${badgeText}</span>
                        <span>${result[translationKey] || ''}</span>
                    </div>
                </div>

                ${tagsHtml ? `<div class="tags-section">
                    <div class="text-muted small mb-2">Tags</div>
                    <div>${tagsHtml}</div>
                </div>` : ''}
            </div>
        </div>
    `;
}

function loadMoreResults() {
    currentPage++;
    const start = (currentPage - 1) * RESULTS_PER_PAGE;
    const end = start + RESULTS_PER_PAGE;
    const nextResults = filteredResults.slice(start, end);
    
    displaySearchResults(nextResults);
}

if (loadMoreBtn) {
    loadMoreBtn.addEventListener('click', loadMoreResults);
}

// --- Tags and Recent Searches ---
const tagsContainer = document.getElementById('tags-container');
const recentList = document.getElementById('recent-list');
const recentContainer = document.getElementById('recent-ul');
const dynamicTagsSection = document.getElementById('dynamic-tags-section');

function displayAvailableTags() {
    if (!tagsContainer || allPhrasesData.length === 0) return;
    if (dynamicTagsSection) dynamicTagsSection.style.display = 'block';

    const allTags = new Set();
    allPhrasesData.forEach(phrase => {
        if (phrase.tags && Array.isArray(phrase.tags)) {
            phrase.tags.forEach(tag => allTags.add(tag));
        }
    });

    const sortedTags = Array.from(allTags).sort();
    tagsContainer.innerHTML = sortedTags.map(tag => 
        `<button class="tag-pill" data-tag="${tag}">${tag}</button>`
    ).join('');

    document.querySelectorAll('#tags-container .tag-pill').forEach(tagBtn => {
        tagBtn.addEventListener('click', () => {
            const tagValue = tagBtn.dataset.tag;
            if (searchBox) searchBox.value = '';
            filteredResults = allPhrasesData.filter(item => item.tags && item.tags.includes(tagValue));
            currentPage = 1;
            displaySearchResults(filteredResults.slice(0, RESULTS_PER_PAGE));
            notyf.success(`Browsing "${tagValue}" phrases`);
            smoothScrollToResults();
        });
    });
}

function addToRecentSearches(query) {
    let recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    recent = recent.filter(item => item !== query);
    recent.unshift(query);
    recent = recent.slice(0, 5);
    localStorage.setItem('recentSearches', JSON.stringify(recent));
    displayRecentSearches();
}

function displayRecentSearches() {
    if (!recentList || !recentContainer) return;
    
    const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    
    if (recent.length > 0) {
        recentList.style.display = 'block';
        recentContainer.innerHTML = recent.map(query => 
            `<button class="tag-pill recent-search" data-query="${query}">${query}</button>`
        ).join('');
        
        document.querySelectorAll('.recent-search').forEach(btn => {
            btn.addEventListener('click', () => {
                const query = btn.dataset.query;
                if (searchBox) searchBox.value = query;
                performSearch(query);
                smoothScrollToResults();
            });
        });
    } else {
        recentList.style.display = 'none';
    }
}

function smoothScrollToResults() {
    const resultsSection = document.getElementById('results-section') || document.getElementById('results');
    if (resultsSection) {
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// --- PWA Installation ---
const installBanner = document.getElementById('installBanner');
const installBtn = document.getElementById('installBtn');
const dismissBanner = document.getElementById('dismissBanner');

if (installBanner && installBtn && dismissBanner) {
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBanner.classList.add('show');
    });

    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                notyf.success('App installed successfully!');
            }
            deferredPrompt = null;
            installBanner.classList.remove('show');
        }
    });

    dismissBanner.addEventListener('click', () => {
        installBanner.classList.remove('show');
    });
}

// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
        }
    });
});

// Service Worker registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('SW registered:', registration))
            .catch(error => console.error('SW registration failed:', error));
    });
}

// --- Initialization ---

document.addEventListener('DOMContentLoaded', () => {
    initLanguageSelection();
    displayRecentSearches();
    initQuickNav();
    initCategoryShortcuts();
    loadDataAndInit();
});
</script>

<script>
const langSelect = document.getElementById('languageSelect');

function updateVisibleLanguage(lang) {
  document.querySelectorAll('.lang-section').forEach(section => {
    section.classList.toggle('d-none', section.dataset.lang !== lang);
  });
}

if (langSelect) {
  document.addEventListener('DOMContentLoaded', () => {
    const savedLang = localStorage.getItem('preferred-language') || 'english';
    langSelect.value = savedLang;
    updateVisibleLanguage(savedLang);
  });

  langSelect.addEventListener('change', () => {
    const selectedLang = langSelect.value;
    localStorage.setItem('preferred-language', selectedLang);
    updateVisibleLanguage(selectedLang);

    if (typeof notyf !== 'undefined' && typeof notyf.success === 'function') {
      notyf.success(`✅  Preference saved: ${selectedLang.toUpperCase()}`);
    } else {
      console.log(`Language preference saved: ${selectedLang.toUpperCase()}`);
    }
  });
}
</script>
